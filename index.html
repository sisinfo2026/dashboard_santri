<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard Santri - Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .title {
      font-size: 28px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    
    .input-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .input-container input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .input-container input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .search-btn {
      position: absolute;
      right: 8px;
      width: 32px;
      height: 32px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }
    
    .search-btn:hover {
      background: #5a67d8;
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-top: 10px;
    }
    
    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    
    .login-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.error {
      background: #ffe6e6;
      color: #dc3545;
      border-left: 4px solid #dc3545;
      display: block;
    }
    
    .status-message.success {
      background: #e6ffe6;
      color: #198754;
      border-left: 4px solid #198754;
      display: block;
    }
    
    .status-message.loading {
      background: #e7f3ff;
      color: #0066cc;
      border-left: 4px solid #0066cc;
      display: block;
    }
    
    .session-info {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 15px;
      display: none;
    }
    
    .navigation-preview {
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      display: none;
    }
    
    .nav-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .nav-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      color: white;
    }
    
    .nav-btn.data-santri {
      background: #0d6efd;
    }
    
    .nav-btn.tunggakan {
      background: #fd7e14;
    }
    
    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .logout-info {
      margin-top: 15px;
      font-size: 12px;
      color: #666;
    }
    
    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .nav-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">üîí</div>
    <div class="title">Dashboard Santri</div>
    <div class="subtitle">Sistem Login Secure dengan Session 1 Jam</div>
    
    <!-- GANTI bagian form yang lama dengan struktur ini -->

<!-- Login Form -->
<div id="loginForm">
  <!-- Wrap kedua form-group dalam form-row -->
  <div class="form-row">
    <!-- Input ID Santri -->
    <div class="form-group">
      <label for="loginId">ID Santri (9 digit)</label>
      <div class="input-container">
        <input type="text" id="loginId" placeholder="Contoh: 101071447" maxlength="9" pattern="\d{9}" />
        <button type="button" class="search-btn" id="searchBtn" title="Cari ID Santri">üîó</button>
      </div>
    </div>
    
    <!-- Input Password -->
    <div class="form-group">
      <label for="loginPassword">Password (9 digit)</label>
      <div class="input-container">
        <input type="password" id="loginPassword" placeholder="9 digit password" maxlength="9" pattern="\d{9}">
      </div>
    </div>
  </div>
  
  <button onclick="authenticateUser()" id="loginBtn" class="login-btn">
    üîë Login ke Dashboard
  </button>
  
  <div id="statusMessage" class="status-message"></div>
  <div id="sessionInfo" class="session-info">
    Session aktif selama 1 jam setelah login berhasil
  </div>
</div>
    
    <!-- Navigation Dashboard (Hidden until authenticated) -->
    <div id="dashboardNav" class="navigation-preview">
      <div class="nav-title">Dashboard Menu</div>
      <div class="nav-buttons">
        <a href="data_santri.html" class="nav-btn data-santri" id="dataSantriLink">
          üìä Data Santri
        </a>
        <a href="tunggakan.html" class="nav-btn tunggakan" id="tunggakanLink">
          üí∞ Lihat Tunggakan
        </a>
      </div>
      <div class="logout-info">
        Session akan berakhir dalam <span id="sessionTimer">60:00</span> menit
        <br><button onclick="logout()" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
      </div>
    </div>
  </div>
  
  <script>
    // =============================================================================
    // KONFIGURASI
    // =============================================================================
    const SCRIPT_ID_SANTRI = "AKfycbx-4nGLPvNXQnExKrKGwLwp0tnZFchw0wUP5DY2BFJ8yYajTNA3rCW4YatBP1_TQopIVQ";
    const SESSION_DURATION = 60 * 60 * 1000; // 1 jam dalam milliseconds
    const SEARCH_URL = "https://script.google.com/macros/s/AKfycbwMgBavCx9buIYDfcH-TbUgRBneAw6HvkWLzbvqEwXc8b6_2Ei_qqJ_RSyXrmxOcSA9/exec";
    
    // =============================================================================
    // SESSION MANAGEMENT
    // =============================================================================
    let sessionTimer = null;
    let sessionTimeLeft = 60 * 60; // 1 jam dalam detik
    
    // Check existing session on page load
    window.addEventListener('load', function() {
      checkExistingSession();
    });
    
    function checkExistingSession() {
      const sessionData = localStorage.getItem('santriSession');
      
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          const currentTime = new Date().getTime();
          const sessionExpiry = new Date(session.expiry).getTime();
          
          if (currentTime < sessionExpiry) {
            // Session masih valid
            console.log("Session found and valid");
            const timeLeft = Math.floor((sessionExpiry - currentTime) / 1000);
            sessionTimeLeft = timeLeft;
            showDashboardNavigation(session.userData);
            startSessionTimer();
            return;
          } else {
            // Session expired
            localStorage.removeItem('santriSession');
          }
        } catch (error) {
          console.error('Error parsing session:', error);
          localStorage.removeItem('santriSession');
        }
      }
      
      console.log("No valid session found - please login");
    }
    
    function createSession(userData) {
      const expiry = new Date(Date.now() + SESSION_DURATION);
      const sessionData = {
        userData: userData,
        loginTime: new Date().toISOString(),
        expiry: expiry.toISOString(),
        id: userData.id_santri
      };
      
      localStorage.setItem('santriSession', JSON.stringify(sessionData));
      console.log("Session created, expires at:", expiry);
    }
    
    function startSessionTimer() {
      const timerElement = document.getElementById('sessionTimer');
      
      sessionTimer = setInterval(() => {
        sessionTimeLeft--;
        
        const hours = Math.floor(sessionTimeLeft / 3600);
        const minutes = Math.floor((sessionTimeLeft % 3600) / 60);
        const seconds = sessionTimeLeft % 60;
        
        const timeString = `${hours > 0 ? hours + ':' : ''}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timerElement) {
          timerElement.textContent = timeString;
        }
        
        if (sessionTimeLeft <= 0) {
          logout();
          showMessage("Session expired! Silakan login ulang untuk keamanan data.", "error");
        }
      }, 1000);
    }
    
    // =============================================================================
    // AUTHENTICATION FUNCTIONS
    // =============================================================================
    
    async function authenticateUser() {
      const loginId = document.getElementById("loginId").value.trim();
      const loginPassword = document.getElementById("loginPassword").value.trim();
      const loginBtn = document.getElementById("loginBtn");
      
      // Reset status
      hideMessage();
      loginBtn.disabled = true;
      loginBtn.textContent = "üîÑ Memverifikasi...";
      
      // Validasi input
      if (!loginId || !loginPassword) {
        showMessage("‚ö†Ô∏è ID dan Password harus diisi!", "error");
        resetLoginBtn();
        return;
      }
      
      if (!/^\d{9}$/.test(loginId) || !/^\d{9}$/.test(loginPassword)) {
        showMessage("‚ö†Ô∏è ID dan Password harus 9 digit angka!", "error");
        resetLoginBtn();
        return;
      }
      
      try {
        showMessage("üîÑ Menghubungi server...", "loading");
        
        const gasUrl = `https://script.google.com/macros/s/${SCRIPT_ID_SANTRI}/exec?id=${encodeURIComponent(loginId)}`;
        console.log("Authenticating with:", gasUrl);
        
        const response = await fetch(gasUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log("Auth response:", result);
        
        if (result.success && result.data) {
          // Verifikasi password
          if (result.data.password === loginPassword) {
            // Autentikasi berhasil
            showMessage("‚úÖ Login berhasil! Memuat dashboard...", "success");
            
            // Create session
            createSession(result.data);
            
            // Reset session timer
            sessionTimeLeft = 60 * 60;
            
            // Show dashboard navigation after delay
            setTimeout(() => {
              showDashboardNavigation(result.data);
              startSessionTimer();
            }, 1500);
            
          } else {
            showMessage("‚ùå Password salah!", "error");
            resetLoginBtn();
          }
        } else {
          showMessage("‚ùå ID Santri tidak ditemukan!", "error");
          resetLoginBtn();
        }
        
      } catch (error) {
        console.error('Auth error:', error);
        showMessage(`‚ö†Ô∏è Error koneksi: ${error.message}`, "error");
        resetLoginBtn();
      }
    }
    
    // =============================================================================
    // UI FUNCTIONS
    // =============================================================================
    
    function showDashboardNavigation(userData) {
      // Hide login form
      document.getElementById("loginForm").style.display = "none";
      
      // Show dashboard navigation
      document.getElementById("dashboardNav").style.display = "block";
      
      // Update page title
      document.querySelector('.title').textContent = `Dashboard - ${userData.nama}`;
      document.querySelector('.subtitle').textContent = `ID: ${userData.id_santri} | Session aktif`;
      
      // Update navigation links with session data
      updateNavigationLinks(userData);
    }
    
    function updateNavigationLinks(userData) {
      const dataSantriLink = document.getElementById("dataSantriLink");
      const tunggakanLink = document.getElementById("tunggakanLink");
      
      // Add session parameter to links
      const sessionParam = `?session=${encodeURIComponent(btoa(JSON.stringify({
        id: userData.id_santri,
        nama: userData.nama,
        timestamp: Date.now()
      })))}`;
      
      dataSantriLink.href = `data_santri.html${sessionParam}`;
      tunggakanLink.href = `tunggakan.html${sessionParam}`;
    }
    
    function showMessage(text, type) {
      const messageEl = document.getElementById("statusMessage");
      messageEl.textContent = text;
      messageEl.className = `status-message ${type}`;
    }
    
    function hideMessage() {
      const messageEl = document.getElementById("statusMessage");
      messageEl.className = "status-message";
    }
    
    function resetLoginBtn() {
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.disabled = false;
      loginBtn.textContent = "üîë Login ke Dashboard";
    }
    
    function logout() {
      // Clear session
      localStorage.removeItem('santriSession');
      
      if (sessionTimer) {
        clearInterval(sessionTimer);
        sessionTimer = null;
      }
      sessionTimeLeft = 60 * 60;
      
      // Reset UI
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("dashboardNav").style.display = "none";
      
      // Reset form
      document.getElementById("loginId").value = "";
      document.getElementById("loginPassword").value = "";
      hideMessage();
      resetLoginBtn();
      
      // Reset title
      document.querySelector('.title').textContent = "Dashboard Santri";
      document.querySelector('.subtitle').textContent = "Sistem Login Secure dengan Session 1 Jam";
      
      console.log("Logged out successfully");
    }
    
    // =============================================================================
    // EVENT LISTENERS
    // =============================================================================
    
    // Enter key support
    document.getElementById("loginId").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        document.getElementById("loginPassword").focus();
      }
    });
    
    document.getElementById("loginPassword").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        authenticateUser();
      }
    });
    
    // Search button
    document.getElementById('searchBtn').addEventListener('click', function() {
      window.open(SEARCH_URL, '_blank');
    });
    
    // Prevent form submission
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
    
  </script>
</body>
</html>
