<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard Santri</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .header {
      background: linear-gradient(90deg, #0d6efd, #6610f2);
      color: white;
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .auth-section {
      margin: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 400px;
      margin: 20px auto;
    }
    .auth-section input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    .auth-section button {
      width: 100%;
      padding: 12px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }
    .auth-section button:hover {
      background: #0b5ed7;
    }
    .auth-section button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    #profile {
      margin: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: inline-block;
      min-width: 280px;
      display: none;
    }
	
	#openPageBtn {
    width: 20px;
    height: 20px;
    font-size: 12px;   /* biar emoji tidak terlalu besar */
    padding: 0;        /* hilangkan padding default */
    line-height: 20px; /* agar konten pas di tengah */
    text-align: center;
  }
	
    .card {
      display: inline-block;
      background: #fff;
      padding: 20px;
      margin: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 200px;
      height: 120px;
      vertical-align: top;
    }
    .card span {
      font-size: 18px;
      color: #333;
      font-weight: bold;
      display: block;
      margin-top: 8px;
    }
    .error {
      color: #dc3545;
    }
    .success {
      color: #198754;
    }
    .warning {
      color: #fd7e14;
    }
    .cards-container {
      display: none;
    }
    .logout-btn {
      margin: 10px;
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
    .logout-btn:hover {
      background: #c82333;
    }
    .session-info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 12px;
      color: #0066cc;
      display: none;
    }
    .navigation {
      margin: 20px 0;
      display: none;
    }
    .nav-btn {
      padding: 10px 20px;
      margin: 0 10px;
      background: #6610f2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .nav-btn:hover {
      background: #5a0fbf;
    }
    .nav-btn.active {
      background: #0d6efd;
    }
    
    /* Style untuk iframe container */
    .iframe-container {
      display: none;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 95%;
    }
    
    .iframe-header {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #fd7e14;
    }
    
    .iframe-content {
      min-height: 400px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: #fff;
    }
    
    #tunggakanIframe {
      width: 100%;
      height: 500px;
      border: none;
      border-radius: 6px;
    }
    
    .close-iframe {
      float: right;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .close-iframe:hover {
      background: #c82333;
    }
    
    .tunggakan-loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    üîí Dashboard Santri - Secure
    <button class="logout-btn" id="logoutBtn" onclick="logout()">Logout</button>
  </div>
  
  <!-- FORM AUTENTIKASI -->
  <div class="auth-section" id="authSection">
    <h3>üîê Login Required</h3>
    <p style="color: #666; font-size: 14px;">Masukkan ID Santri dan Password untuk mengakses dashboard</p>
    
    <label for="loginId">ID Santri (9 digit)</label><br>
    <div class="input-with-button">
      <button type="button" id="openPageBtn" title="Cari ID Santri">üîó</button>
      <input type="text" id="loginId" placeholder="Contoh: 101071447" maxlength="9" pattern="\d{9}" />
    </div>
    
    <label for="loginPassword">Password (9 digit)</label>
    <input type="password" id="loginPassword" placeholder="9 digit password" maxlength="9" pattern="\d{9}">
    
    <button onclick="authenticateUser()" id="loginBtn">üîë Login ke Dashboard</button>
    
    <div class="session-info" id="sessionInfo">
      Session akan expired dalam <span id="sessionTimer">15:00</span> menit
    </div>
    
    <div id="authStatus" style="margin-top:10px;"></div>
  </div>
  
  <!-- NAVIGATION -->
  <div class="navigation" id="navigation">
    <button class="nav-btn active" id="dataSantriBtn" onclick="showDataSantri()">üìä Data Santri</button>
    <button class="nav-btn" id="tunggakanBtn" onclick="showTunggakan()">üí∞ Lihat Tunggakan</button>
  </div>
  
  <!-- DASHBOARD CONTENT (Hidden until authenticated) -->
  <div id="dashboardContent" style="display: none;">
    <div id="profile">
      <p><b id="status">Memuat data...</b></p>
      <p>ID Santri: <span id="idSantri">-</span></p>
      <p>Nama: <span id="nama">-</span></p>
    </div>
    
    <div class="cards-container" id="cardsContainer">
      <div class="card">
        KELAS
        <span id="kelas">-</span>
      </div>
      <div class="card">
        JENIS KELAMIN
        <span id="jk">-</span>
      </div>
      <div class="card">
        NAMA AYAH
        <span id="ayah">-</span>
      </div>
      <div class="card">
        PASSWORD
        <span id="password">-</span>
		<br> (Untuk mengubah password hubungi admin)
	  </div>
    </div>
  </div>
  
  <!-- TUNGGAKAN IFRAME CONTAINER -->
  <div class="iframe-container" id="tunggakanContainer">
    <div class="iframe-header">
      <button class="close-iframe" onclick="closeTunggakan()">‚úï Tutup</button>
      <h3 style="margin: 0; color: #fd7e14;">üí∞ Data Tunggakan Santri</h3>
      <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
        Menampilkan informasi tunggakan untuk ID: <span id="tunggakanSantriId">-</span>
      </p>
    </div>
    <div class="iframe-content">
      <div class="tunggakan-loading" id="tunggakanLoading">
        üîÑ Memuat data tunggakan...
      </div>
      <iframe id="tunggakanIframe" style="display:none;"></iframe>
    </div>
  </div>
  
  <script>
    // =============================================================================
    // KONFIGURASI SCRIPT URLs - GANTI DENGAN SCRIPT ID ANDA
    // =============================================================================
    
    // Script ID untuk autentikasi dan data santri (yang sudah ada)
    const SCRIPT_ID_SANTRI = "AKfycbx-4nGLPvNXQnExKrKGwLwp0tnZFchw0wUP5DY2BFJ8yYajTNA3rCW4YatBP1_TQopIVQ";
    
    // Script ID untuk data tunggakan (yang baru - sudah di-deploy)
    const SCRIPT_ID_TUNGGAKAN = "AKfycbyir6-WyUeMFbBkr3YiuCnLcEw2X49BZ380jaMj0oNn0q5t6SLfCbt1XJSzXjMXLmGK2Q";
	
   
    // =============================================================================
    // SESSION MANAGEMENT
    // =============================================================================
    let sessionTimer = null;
    let sessionTimeLeft = 15 * 60; // 15 menit dalam detik
    let authenticatedUser = null;
    
    // Check existing session on page load
    window.addEventListener('load', function() {
      console.log("Dashboard loaded - please login");
    });
    
    // =============================================================================
    // AUTHENTICATION FUNCTIONS
    // =============================================================================
    
    async function authenticateUser() {
      const loginId = document.getElementById("loginId").value.trim();
      const loginPassword = document.getElementById("loginPassword").value.trim();
      const authStatus = document.getElementById("authStatus");
      const loginBtn = document.getElementById("loginBtn");
      
      // Reset status
      authStatus.innerHTML = "";
      loginBtn.disabled = true;
      loginBtn.textContent = "üîÑ Memverifikasi...";
      
      // Validasi input
      if (!loginId || !loginPassword) {
        authStatus.innerHTML = '<span class="error">‚ö†Ô∏è ID dan Password harus diisi!</span>';
        resetLoginBtn();
        return;
      }
      
      if (!/^\d{9}$/.test(loginId) || !/^\d{9}$/.test(loginPassword)) {
        authStatus.innerHTML = '<span class="error">‚ö†Ô∏è ID dan Password harus 9 digit angka!</span>';
        resetLoginBtn();
        return;
      }
      
      try {
        // Call Google Apps Script untuk autentikasi (Script 1)
        const gasUrl = `https://script.google.com/macros/s/${SCRIPT_ID_SANTRI}/exec?id=${encodeURIComponent(loginId)}`;
        console.log("Authenticating with Script 1:", gasUrl);
        
        const response = await fetch(gasUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log("Auth response:", result);
        
        if (result.success && result.data) {
          // Verifikasi password
          if (result.data.password === loginPassword) {
            // Autentikasi berhasil
            authenticatedUser = {
              id: loginId,
              data: result.data,
              loginTime: new Date()
            };
            
            authStatus.innerHTML = '<span class="success">‚úÖ Login berhasil! Memuat dashboard...</span>';
            
            // Tampilkan dashboard
            setTimeout(() => {
              showDashboard(result.data);
              startSessionTimer();
            }, 1000);
            
          } else {
            authStatus.innerHTML = '<span class="error">‚ùå Password salah!</span>';
            resetLoginBtn();
          }
        } else {
          authStatus.innerHTML = '<span class="error">‚ùå ID Santri tidak ditemukan!</span>';
          resetLoginBtn();
        }
        
      } catch (error) {
        console.error('Auth error:', error);
        authStatus.innerHTML = '<span class="error">‚ö†Ô∏è Error koneksi: ' + error.message + '</span>';
        resetLoginBtn();
      }
    }
    
    // =============================================================================
    // DASHBOARD FUNCTIONS
    // =============================================================================
    
    function showDashboard(userData) {
      // Sembunyikan form login
      document.getElementById("authSection").style.display = "none";
      
      // Tampilkan dashboard
      document.getElementById("dashboardContent").style.display = "block";
      document.getElementById("profile").style.display = "inline-block";
      document.getElementById("cardsContainer").style.display = "block";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("navigation").style.display = "block";
      
      // Populate data
      document.getElementById("status").innerHTML = '<span class="success">‚úÖ Data ditemukan</span>';
      document.getElementById("idSantri").innerText = userData.id_santri || "-";
      document.getElementById("nama").innerText = userData.nama || "-";
      document.getElementById("kelas").innerText = userData.kelas_sekarang || "-";
      document.getElementById("jk").innerText = userData.gender || "-";
      document.getElementById("ayah").innerText = userData.nama_ayah || "-";
      document.getElementById("password").innerText = userData.password || "-";
    }
    
    function showDataSantri() {
      // Update navigation buttons
      document.getElementById("dataSantriBtn").classList.add("active");
      document.getElementById("tunggakanBtn").classList.remove("active");
      
      // Show data santri, hide tunggakan
      document.getElementById("dashboardContent").style.display = "block";
      document.getElementById("tunggakanContainer").style.display = "none";
    }
    
    function showTunggakan() {
      if (!authenticatedUser) {
        alert("Silakan login terlebih dahulu!");
        return;
      }
      
      // Update navigation buttons
      document.getElementById("dataSantriBtn").classList.remove("active");
      document.getElementById("tunggakanBtn").classList.add("active");
      
      // Hide data santri, show tunggakan
      document.getElementById("dashboardContent").style.display = "none";
      document.getElementById("tunggakanContainer").style.display = "block";
      
      // Update header dengan ID santri
      document.getElementById("tunggakanSantriId").textContent = authenticatedUser.id;
      
      // Load tunggakan data dalam iframe
      loadTunggakanData();
    }
    
    // =============================================================================
    // TUNGGAKAN FUNCTIONS
    // =============================================================================
    
    function loadTunggakanData() {
      const iframe = document.getElementById("tunggakanIframe");
      const loading = document.getElementById("tunggakanLoading");
      
      // Show loading
      loading.style.display = "block";
      iframe.style.display = "none";
      
      // Generate HTML content for tunggakan
      generateTunggakanHTML();
    }
    
    async function generateTunggakanHTML() {
      try {
        // Call Google Apps Script untuk data tunggakan (Script 2)
        const tunggakanUrl = `https://script.google.com/macros/s/${SCRIPT_ID_TUNGGAKAN}/exec?id=${encodeURIComponent(authenticatedUser .id)}`;
        console.log("Fetching tunggakan with Script 2:", tunggakanUrl);
        
        const response = await fetch(tunggakanUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log("Tunggakan response:", result);
        
        let htmlContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Data Tunggakan</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f8f9fa;
              }
              .tunggakan-header {
                background: linear-gradient(90deg, #fd7e14, #ffc107);
                color: white;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                text-align: center;
              }
              .tunggakan-card {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 15px;
              }
              .total-tunggakan {
                font-size: 24px;
                font-weight: bold;
                color: #dc3545;
                text-align: center;
                padding: 15px;
                background: #fff3f3;
                border-radius: 8px;
                border-left: 4px solid #dc3545;
              }
              .detail-tunggakan {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-top: 20px;
              }
              .detail-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border-left: 3px solid #6610f2;
              }
              .detail-item .label {
                font-weight: bold;
                color: #495057;
                font-size: 14px;
                margin-bottom: 5px;
              }
              .detail-item .value {
                font-size: 18px;
                color: #dc3545;
                font-weight: bold;
              }
              .no-tunggakan {
                text-align: center;
                padding: 40px;
                color: #198754;
                font-size: 18px;
              }
              .error-message {
                text-align: center;
                padding: 40px;
                color: #dc3545;
                font-size: 16px;
              }
            </style>
          </head>
          <body>
            <div class="tunggakan-header">
              <h2>üí∞ Data Tunggakan Santri</h2>
              <p>ID Santri: ${authenticatedUser.id} | Nama: ${authenticatedUser.data.nama}</p>
            </div>
        `;
        
        if (result.success && result.data) {
          const tunggakan = result.data;
          const totalTunggakan = parseInt(tunggakan.total_tunggakan) || 0;
          
          if (totalTunggakan > 0) {
            htmlContent += `
              <div class="tunggakan-card">
                <div class="total-tunggakan">
                  Total Tunggakan: Rp ${formatCurrency(totalTunggakan)}
                </div>
                
                <div class="detail-tunggakan">
                  <div class="detail-item">
                    <div class="label">Sarana Prasarana</div>
                    <div class="value">Rp ${formatCurrency(parseInt(tunggakan.sarpras) || 0)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">BOP (Biaya Operasional)</div>
                    <div class="value">Rp ${formatCurrency(parseInt(tunggakan.bop) || 0)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Kegiatan</div>
                    <div class="value">Rp ${formatCurrency(parseInt(tunggakan.kegiatan) || 0)}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Perlengkapan</div>
                    <div class="value">Rp ${formatCurrency(parseInt(tunggakan.perlengkapan) || 0)}</div>
                  </div>
                </div>
              </div>
              
              <div class="tunggakan-card">
                <h4 style="color: #495057; margin-top: 0;">üìã Informasi Tambahan</h4>
                <p style="color: #666; font-size: 14px;">
                  ‚Ä¢ Silakan hubungi bagian keuangan untuk informasi lebih detail<br>
                  ‚Ä¢ Pembayaran dapat dilakukan melalui transfer bank atau langsung ke kantor<br>
                  ‚Ä¢ Data ini insyaallah diperbarui secara berkala
                </p>
              </div>
            `;
          } else {
            htmlContent += `
              <div class="tunggakan-card">
                <div class="no-tunggakan">
                  ‚úÖ Alhamdulillah, tidak ada tunggakan!<br>
                  <small style="color: #666;">Semua pembayaran sudah lunas</small>
                </div>
              </div>
            `;
          }
        } else {
          htmlContent += `
            <div class="tunggakan-card">
              <div class="error-message">
                ‚ö†Ô∏è Tidak dapat memuat data tunggakan<br>
                <small>${result.error || 'Silakan coba lagi atau hubungi administrator'}</small>
              </div>
            </div>
          `;
        }
        
        htmlContent += `
            <script>
              function formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID').format(amount);
              }
            <\/script>
          </body>
          </html>
        `;
        
        // Set iframe content
        const iframe = document.getElementById("tunggakanIframe");
        iframe.onload = function() {
          document.getElementById("tunggakanLoading").style.display = "none";
          iframe.style.display = "block";
        };
        
        iframe.srcdoc = htmlContent;
        
      } catch (error) {
        console.error('Error loading tunggakan:', error);
        
        // Show error in iframe
        const errorHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { 
                font-family: Arial, sans-serif; 
                padding: 40px; 
                text-align: center; 
                background: #f8f9fa;
              }
              .error { 
                color: #dc3545; 
                font-size: 16px; 
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
            </style>
          </head>
          <body>
            <div class="error">
              ‚ö†Ô∏è Error memuat data tunggakan<br>
              <small>${error.message}</small><br><br>
              <small style="color: #666;">
                Pastikan Script ID tunggakan sudah benar dan script sudah di-deploy
              </small>
            </div>
          </body>
          </html>
        `;
        
        const iframe = document.getElementById("tunggakanIframe");
        iframe.srcdoc = errorHtml;
        iframe.onload = function() {
          document.getElementById("tunggakanLoading").style.display = "none";
          iframe.style.display = "block";
        };
      }
    }
    
    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID').format(amount);
    }
    
    function closeTunggakan() {
      showDataSantri();
    }
    
    function resetLoginBtn() {
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.disabled = false;
      loginBtn.textContent = "üîë Login ke Dashboard";
    }
    
    function startSessionTimer() {
      document.getElementById("sessionInfo").style.display = "block";
      
      sessionTimer = setInterval(() => {
        sessionTimeLeft--;
        
        const minutes = Math.floor(sessionTimeLeft / 60);
        const seconds = sessionTimeLeft % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById("sessionTimer").textContent = timeString;
        
        if (sessionTimeLeft <= 0) {
          logout();
          alert("Session expired! Silakan login ulang untuk keamanan data.");
        }
      }, 1000);
    }
    
    function logout() {
      // Clear session
      if (sessionTimer) {
        clearInterval(sessionTimer);
        sessionTimer = null;
      }
      sessionTimeLeft = 15 * 60;
      authenticatedUser = null;
      
      // Reset UI
      document.getElementById("authSection").style.display = "block";
      document.getElementById("dashboardContent").style.display = "none";
      document.getElementById("tunggakanContainer").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sessionInfo").style.display = "none";
      document.getElementById("navigation").style.display = "none";
      
      // Reset navigation
      document.getElementById("dataSantriBtn").classList.add("active");
      document.getElementById("tunggakanBtn").classList.remove("active");
      
      // Clear form
      document.getElementById("loginId").value = "";
      document.getElementById("loginPassword").value = "";
      document.getElementById("authStatus").innerHTML = "";
      
      resetLoginBtn();
    }
    
    // =============================================================================
    // EVENT LISTENERS
    // =============================================================================
    
    // Enter key support
    document.getElementById("loginId").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        document.getElementById("loginPassword").focus();
      }
    });
    
    document.getElementById("loginPassword").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        authenticateUser();
      }
    });
	
	// MEMBUKA SCRIPT PENCARIAN DATA SANTRI
	document.getElementById('openPageBtn').addEventListener('click', function() {
    window.open('https://script.google.com/macros/s/AKfycbwMgBavCx9buIYDfcH-TbUgRBneAw6HvkWLzbvqEwXc8b6_2Ei_qqJ_RSyXrmxOcSA9/exec', '_blank');
});
	
  </script>
</body>
</html>
